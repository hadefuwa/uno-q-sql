{
  "permissions": {
    "allow": [
      "Bash(ssh:*)",
      "Bash(test:*)",
      "Bash(ssh-keygen:*)",
      "Bash(git remote add:*)",
      "Bash(\"c:/Users/Hamed/Documents/uno q sql/scripts/export_gpio_data.py\")",
      "Bash(\"c:/Users/Hamed/Documents/uno q sql/scripts/web_viewer.py\")",
      "Bash(\"c:/Users/Hamed/Documents/uno q sql/templates/index.html\")",
      "Bash(git add:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nInitial commit: Arduino UNO Q SQLite logging system\n\nComplete solution for logging data to SQLite in Docker containers\nand accessing it from the host Debian system.\n\nFeatures:\n- Data logging brick (main.py)\n- Database export script\n- Web-based data viewer\n- Comprehensive documentation\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git commit:*)",
      "Bash(git branch:*)",
      "Bash(git push:*)",
      "Bash('\"\"\n        subprocess.run(\n            [\"\"docker\"\", \"\"exec\"\", container_id, \"\"sh\"\", \"\"-c\"\", clear_cmd],\n            check=True\n        )\n        \n        return True\n    except Exception as e:\n        print(f\"\"Clear error: {e}\"\")\n        return False\n\ndef get_db_data(limit=100):\n    \"\"\"\"\"\"Fetch data from the database\"\"\"\"\"\"\n    try:\n        # Export fresh data before reading\n        export_fresh_data()\n        \n        conn = sqlite3.connect(DATABASE)\n        conn.row_factory = sqlite3.Row\n        cursor = conn.cursor()\n        \n        # Get total count\n        cursor.execute(\"\"SELECT COUNT(*) as count FROM gpio_log\"\")\n        total = cursor.fetchone()[\"\"count\"\"]\n        \n        # Get entries with limit\n        cursor.execute(f\"\"SELECT * FROM gpio_log ORDER BY id DESC LIMIT {limit}\"\")\n        entries = [dict(row) for row in cursor.fetchall()]\n        \n        # Get first and last timestamp\n        first_ts = None\n        last_ts = None\n        if total > 0:\n            cursor.execute(\"\"SELECT timestamp FROM gpio_log ORDER BY id LIMIT 1\"\")\n            first_ts = cursor.fetchone()[\"\"timestamp\"\"]\n            cursor.execute(\"\"SELECT timestamp FROM gpio_log ORDER BY id DESC LIMIT 1\"\")\n            last_ts = cursor.fetchone()[\"\"timestamp\"\"]\n        \n        conn.close()\n        \n        return {\n            \"\"total\"\": total,\n            \"\"entries\"\": entries,\n            \"\"first_timestamp\"\": first_ts,\n            \"\"last_timestamp\"\": last_ts\n        }\n    except Exception as e:\n        return {\"\"error\"\": str(e), \"\"total\"\": 0, \"\"entries\"\": [], \"\"first_timestamp\"\": None, \"\"last_timestamp\"\": None}\n\n@app.route(\"\"/\"\")\ndef index():\n    return render_template(\"\"index.html\"\")\n\n@app.route(\"\"/api/data\"\")\ndef api_data():\n    \"\"\"\"\"\"API endpoint to get fresh data - automatically exports from container\"\"\"\"\"\"\n    limit = request.args.get(\"\"limit\"\", 100, type=int)\n    return jsonify(get_db_data(limit))\n\n@app.route(\"\"/api/clear\"\", methods=[\"\"POST\"\"])\ndef api_clear():\n    \"\"\"\"\"\"Clear all data from the database\"\"\"\"\"\"\n    try:\n        success = clear_container_database()\n        if success:\n            # Also clear the exported file\n            if os.path.exists(DATABASE):\n                os.remove(DATABASE)\n            return jsonify({\"\"success\"\": True, \"\"message\"\": \"\"Database cleared successfully\"\"})\n        else:\n            return jsonify({\"\"success\"\": False, \"\"message\"\": \"\"Failed to clear database\"\"})\n    except Exception as e:\n        return jsonify({\"\"success\"\": False, \"\"message\"\": str(e)})\n\n@app.route(\"\"/api/export/csv\"\")\ndef api_export_csv():\n    \"\"\"\"\"\"Export all data as CSV\"\"\"\"\"\"\n    try:\n        export_fresh_data()\n        \n        conn = sqlite3.connect(DATABASE)\n        cursor = conn.cursor()\n        cursor.execute(\"\"SELECT * FROM gpio_log ORDER BY id\"\")\n        rows = cursor.fetchall()\n        \n        # Get column names\n        cursor.execute(\"\"PRAGMA table_info(gpio_log)\"\")\n        columns = [col[1] for col in cursor.fetchall()]\n        \n        conn.close()\n        \n        # Create CSV in memory\n        output = io.StringIO()\n        writer = csv.writer(output)\n        writer.writerow(columns)\n        writer.writerows(rows)\n        \n        # Convert to bytes\n        output.seek(0)\n        return send_file(\n            io.BytesIO(output.getvalue().encode()),\n            mimetype=\"\"text/csv\"\",\n            as_attachment=True,\n            download_name=f\"\"gpio_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv\"\"\n        )\n    except Exception as e:\n        return jsonify({\"\"error\"\": str(e)})\n\n@app.route(\"\"/api/stats\"\")\ndef api_stats():\n    \"\"\"\"\"\"Get database statistics\"\"\"\"\"\"\n    try:\n        export_fresh_data()\n        \n        conn = sqlite3.connect(DATABASE)\n        cursor = conn.cursor()\n        \n        # Total entries\n        cursor.execute(\"\"SELECT COUNT(*) as count FROM gpio_log\"\")\n        total = cursor.fetchone()[0]\n        \n        # Count by pin state\n        cursor.execute(\"\"SELECT pin_state, COUNT(*) as count FROM gpio_log GROUP BY pin_state\"\")\n        pin_counts = dict(cursor.fetchall())\n        \n        # Count by led state\n        cursor.execute(\"\"SELECT led_state, COUNT(*) as count FROM gpio_log GROUP BY led_state\"\")\n        led_counts = dict(cursor.fetchall())\n        \n        # Database file size\n        db_size = os.path.getsize(DATABASE) if os.path.exists(DATABASE) else 0\n        \n        conn.close()\n        \n        return jsonify({\n            \"\"total_entries\"\": total,\n            \"\"pin_state_counts\"\": pin_counts,\n            \"\"led_state_counts\"\": led_counts,\n            \"\"database_size_kb\"\": round(db_size / 1024, 2)\n        })\n    except Exception as e:\n        return jsonify({\"\"error\"\": str(e)})\n\nif __name__ == \"\"__main__\"\":\n    print(\"\"Starting enhanced web viewer...\"\")\n    print(\"\"Features:\"\")\n    print(\"\"  - Auto-export from Docker container\"\")\n    print(\"\"  - Clear database\"\")\n    print(\"\"  - Export to CSV\"\")\n    print(\"\"  - Statistics dashboard\"\")\n    print(\"\"\"\")\n    app.run(host=\"\"0.0.0.0\"\", port=5000, debug=True)\nENDOFFILE\n')"
    ],
    "deny": [],
    "ask": []
  }
}
